<!doctype html>
<meta charset="utf-8" />
<title>Web Push 設定</title>
<style>
  :root{--ok:#31a24c;--okbg:#e8fff0;--ng:#d13a3a;--ngbg:#ffeded;--info:#1e51c7;--infobg:#eef5ff}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:24px;line-height:1.6}
  h1{font-size:20px;margin:0 0 12px}
  .card{border:1px solid #ddd;border-radius:12px;padding:16px;margin:12px 0}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .badge{padding:4px 10px;border-radius:999px;font-size:12px;border:1px solid transparent}
  .ok{background:var(--okbg);border-color:var(--ok);color:#156c2e}
  .ng{background:var(--ngbg);border-color:var(--ng);color:#8a1c1c}
  .info{background:var(--infobg);border-color:#6a9efb;color:var(--info)}
  button{padding:10px 14px;border-radius:10px;border:1px solid #ccc;background:#fff;cursor:pointer}
  button.primary{background:#1e51c7;color:#fff;border-color:#1e51c7;font-weight:600}
  button:disabled{opacity:.6;cursor:not-allowed}
  ol{margin:0 0 8px 20px;padding:0}
  small{color:#666}
  .spacer{height:8px}
  .danger{color:#8a1c1c}
</style>

<h1>Web Push 設定</h1>

<div class="card">
  <div style="margin-bottom:8px;font-weight:600">使い方</div>
  <ol>
    <li>「通知を許可」を押して、ブラウザの通知権限を許可します。</li>
    <li>「Push を購読」を押して、購読を作成します。</li>
    <li>下の <b>3つのバッジがすべて緑</b>になったら、<b>「完了（Gradioへ送信して閉じる）」</b>を押してください。</li>
  </ol>
</div>

<div class="card">
  <div class="row">
    <div>Service Worker:</div>
    <span id="swStatus" class="badge info">未実行</span>
  </div>
  <div class="row" style="margin-top:8px">
    <div>通知権限:</div>
    <span id="permStatus" class="badge info">未確認</span>
    <button id="btnPerm" class="primary">通知を許可</button>
  </div>
  <div class="row" style="margin-top:8px">
    <div>Push 購読:</div>
    <span id="subStatus" class="badge info">未購読</span>
    <button id="btnSub">Push を購読</button>
    <button id="btnUnsub">購読解除</button>
  </div>
</div>

<div class="card">
  <div class="row" style="width:100%;justify-content:space-between;align-items:center">
    <button id="btnDone" class="primary" disabled>完了（Gradioへ送信して閉じる）</button>
    <small id="hint">3つが緑になったら押せます。</small>
  </div>
  <div id="directWarn" class="spacer"></div>
</div>

<script>
  // ---- 設定 ----
  const VAPID_PUBLIC_KEY = "BKDYl1tog8AGY9kq9b94ztIroWBw1smpQp5kGTh5-O1Apz3cFSQO_f7kes_ct7QTVtPSYQaaOZv83eV28kprzNk";

  // ---- ユーティリティ ----
  function urlB64ToUint8Array(s){const p="=".repeat((4-s.length%4)%4);const b=(s+p).replace(/-/g,"+").replace(/_/g,"/");const r=atob(b);const a=new Uint8Array(r.length);for(let i=0;i<r.length;i++)a[i]=r.charCodeAt(i);return a;}
  const el = (id)=>document.getElementById(id);
  const swStatus=el("swStatus"), permStatus=el("permStatus"), subStatus=el("subStatus");
  const btnPerm=el("btnPerm"), btnSub=el("btnSub"), btnUnsub=el("btnUnsub"), btnDone=el("btnDone");
  const hint=el("hint"), directWarn=el("directWarn");

  let reg = null;
  let currentSub = null;
  let openerOrigin = "*";
  try { openerOrigin = new URL(document.referrer).origin; } catch(_) {}

  function setBadge(node, cls, text){ node.className = "badge " + cls; node.textContent = text; }
  function isAllGreen(){
    const swOK = reg !== null;
    const permOK = Notification.permission === "granted";
    const subOK = !!currentSub;
    return swOK && permOK && subOK;
  }
  function updateDoneState(){
    btnDone.disabled = !isAllGreen();
    hint.textContent = btnDone.disabled ? "3つが緑になったら押せます。" : "このボタンで Gradio に送信してウィンドウを閉じます。";
  }

  function refreshPermBadge(){
    const p = Notification.permission;
    if (p === "granted") { setBadge(permStatus,"ok","許可済み"); btnPerm.disabled=true; }
    else if (p === "denied"){ setBadge(permStatus,"ng","拒否（ブラウザ設定で変更）"); btnPerm.disabled=true; }
    else { setBadge(permStatus,"info","要許可"); btnPerm.disabled=false; }
    updateDoneState();
  }
  function refreshSubBadge(){
    if (currentSub) { setBadge(subStatus,"ok","購読済み"); }
    else { setBadge(subStatus,"info","未購読"); }
    updateDoneState();
  }

  async function ensureSW(){
    if (!("serviceWorker" in navigator) || !("PushManager" in window)) {
      setBadge(swStatus,"ng","非対応"); throw new Error("このブラウザは非対応です");
    }
    setBadge(swStatus,"info","登録中…");
    reg = await navigator.serviceWorker.register("./sw.js",{scope:"./"});
    setBadge(swStatus,"ok","登録完了");
    updateDoneState();
  }

  async function loadExistingSub(){
    currentSub = await reg.pushManager.getSubscription();
    refreshSubBadge(); // 自動送信はしない（必ず確定ボタン）
  }

  async function requestPermission(){
    if (Notification.permission !== "granted") {
      await Notification.requestPermission();
      refreshPermBadge();
    }
  }

  async function subscribe(){
    await requestPermission();
    if (Notification.permission !== "granted") return;
    currentSub = await reg.pushManager.subscribe({
      userVisibleOnly:true,
      applicationServerKey: urlB64ToUint8Array(VAPID_PUBLIC_KEY)
    });
    // ローカルに保存（任意）：次回の利便性向上。送信は確定ボタンのみ。
    try { localStorage.setItem("push_sub_json", JSON.stringify(currentSub.toJSON())); } catch(_) {}
    refreshSubBadge();
  }

  async function unsubscribe(){
    const sub = await reg.pushManager.getSubscription();
    if (sub) await sub.unsubscribe();
    currentSub = null;
    try { localStorage.removeItem("push_sub_json"); } catch(_) {}
    refreshSubBadge();
  }

  btnPerm.onclick = requestPermission;
  btnSub.onclick = subscribe;
  btnUnsub.onclick = unsubscribe;

  btnDone.onclick = () => {
    if (!isAllGreen()) return;
    // 親（Gradio）へ送信して閉じる（確定操作は必ずこのボタン）
    const payload = currentSub ? currentSub.toJSON() : null;
    try {
      if (window.opener && payload) {
        window.opener.postMessage({ type:"PUSH_SUB", subscription: payload }, openerOrigin);
      }
    } catch(_) {}
    window.close();
  };

  (async () => {
    // 直リンク警告（openerが無い場合）
    if (!window.opener) {
      directWarn.innerHTML = '<small class="danger">※ このページは Gradio から開いてください。直リンクでは送信先がありません。</small>';
    }
    try {
      await ensureSW();
      refreshPermBadge();
      await loadExistingSub();
    } catch (e) {
      console.error(e);
      // 失敗でも UI は残す
    }
  })();
</script>